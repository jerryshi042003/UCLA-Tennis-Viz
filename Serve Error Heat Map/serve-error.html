<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serve Error Plot</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-contour.v1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #86ac91;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        svg {
            width: 60%;
            height: 90%;
            display: block;
            font-family: 'DM Sans', sans-serif;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
        }

        .label-text {
            font-size: 18px;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
        }

        .contour {
            fill-opacity: 0.8;
        }
    </style>
</head>
<body style="background-color: #86ac91;">
    <svg width="800" height="650"></svg>
    
    <script>
        d3.json("serve_errors.json").then(function(serve_errors) {
            const svg = d3.select("svg");
            const width = +svg.attr("width");
            const height = +svg.attr("height");

            const xScale = d3.scaleLinear()
                             .domain([-250, 250])
                             .range([0, width]);

            const yScale = d3.scaleLinear()
                             .domain([-470, 70])
                             .range([height, 0]);

            svg.append("text")
               .attr("class", "title")
               .attr("x", width / 2)
               .attr("y", 32.5)
               .text("Serve Error Distribution - " + serve_errors[0].serverName);

            svg.append("rect")
               .attr("x", xScale(-210))
               .attr("y", yScale(30))
               .attr("width", xScale(210) - xScale(-210))
               .attr("height", yScale(-460) - yScale(25))
               .attr("fill", "#6092ce");

            const courtLines = [
                { x1: 210, y1: 30, x2: 210, y2: -455 },
                { x1: -210, y1: 30, x2: -210, y2: -455 },
                { x1: 157.5, y1: 30, x2: 157.5, y2: -455 },
                { x1: -157.5, y1: 30, x2: -157.5, y2: -455 },
                { x1: 240, y1: 0, x2: -240, y2: 0 },
                { x1: 0, y1: 30, x2: 0, y2: -245 },
                { x1: 157.5, y1: -245, x2: -157.5, y2: -245 },
                { x1: 211.25, y1: -455, x2: -211.25, y2: -455 },
                { x1: 0, y1: -445, x2: 0, y2: -455 }
            ];

            svg.selectAll("line")
               .data(courtLines)
               .enter()
               .append("line")
               .attr("x1", function(d) { return xScale(d.x1); })
               .attr("y1", function(d) { return yScale(d.y1); })
               .attr("x2", function(d) { return xScale(d.x2); })
               .attr("y2", function(d) { return yScale(d.y2); })
               .attr("stroke", "white")
               .attr("stroke-width", 4);

            const labels = [
                { label: "Ad", x: -78.25, y: -440 },
                { label: "Deuce", x: 78.25, y: -440 }
            ];

            svg.selectAll("text.label-text")
               .data(labels)
               .enter()
               .append("text")
               .attr("class", "label-text")
               .attr("x", d => xScale(d.x))
               .attr("y", d => yScale(d.y))
               .text(d => d.label);

            const densityData = d3.contourDensity()
                                  .x(d => xScale(d.x))
                                  .y(d => yScale(d.y))
                                  .size([width, height])
                                  .bandwidth(15)(serve_errors);

            const maxDensity = d3.max(densityData, d => d.value);

            const colorScale = d3.scaleLinear()
                .domain([0, maxDensity * 0.1, maxDensity * 0.3, maxDensity * 0.4, maxDensity * 0.6, maxDensity])
                .range(["#6092ce", "#5a7bed", "yellow", "#ffcc00", "orange", "red"]);

            svg.selectAll("path.contour")
               .data(densityData)
               .enter()
               .append("path")
               .attr("class", "contour")
               .attr("d", d3.geoPath())
               .attr("fill", d => colorScale(d.value));
        });
    </script>
</body>
</html>
